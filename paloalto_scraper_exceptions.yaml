# Palo Alto PAN-OS Log Scraper - Exceptions and Corrections
#
# This file encodes corrections needed because:
#   - PA documentation is inconsistent across log types (same concept, different spelling)
#   - PA field tables sometimes have wrong/truncated variable names (typos)
#   - The scraper's name-mapping logic misses some long-name → variable-name lookups
#   - One PA doc page has a literal bug (period instead of comma as separator)

# global_name_overrides: merged into name_map before format string transformation.
# Keys are long field names (as they appear in the format string), values are variable names.
# These supplement and take precedence over auto-detected mappings from each log type's field table.
global_name_overrides:
  # Time fields — PA docs inconsistent: "Generate Time" vs "Generated Time"
  "Generated Time": "time_generated"
  "Generate Time": "time_generated"

  # Threat/URL/Data log — tokens not matched by auto-detection
  "Threat ID": "threatid"
  "Source Location": "srcloc"
  "Destination Location": "dstloc"
  "Parent Start Time": "parent_start_time"
  "PCAP_ID": "pcap_id"

  # Casing fixes — capitalized long names not matched case-insensitively in format string
  "Subtype": "subtype"
  "Serial": "serial"
  "Fingerprint": "fingerprint"
  "Priority": "priority"
  "Gateway": "gateway"

  # Traffic, GTP, Tunnel Inspection — format string uses "Protocol" (short); field table
  # uses "IP Protocol (proto)" (with "IP " prefix). "Protocol" != "ip protocol" so
  # auto-detection fails. Previously hardcoded in _transform_format_string; moved here.
  "Protocol": "proto"

  # GlobalProtect — unmapped long names
  "High Res Timestamp": "high_res_timestamp"
  "Selection Type": "selection_type"
  "Response Time": "response_time"

  # HIP Match
  "IPv6 Source Address": "srcipv6"

  # Device Group Hierarchy — PA uses 3 different naming patterns across log types.
  # "Device Group Hierarchy Level N" is already handled by the code regex.
  "DG Hierarchy Level 1": "dg_hier_level_1"
  "DG Hierarchy Level 2": "dg_hier_level_2"
  "DG Hierarchy Level 3": "dg_hier_level_3"
  "DG Hierarchy Level 4": "dg_hier_level_4"
  "Device Group Hierarchy 1": "dg_hier_level_1"
  "Device Group Hierarchy 2": "dg_hier_level_2"
  "Device Group Hierarchy 3": "dg_hier_level_3"
  "Device Group Hierarchy 4": "dg_hier_level_4"

  # Tunnel Inspection — unmapped long names
  "Tunnel ID/IMSI": "tunnelid"
  "Monitor Tag/IMEI": "monitortag"
  "Tunnel": "tunnel"
  "Strict Check": "strict_check"
  "Rule UUID": "rule_uuid"
  "Dynamic User Group": "dynusergroup_name"

  # Decryption — unmapped long names
  "Threat/Content Type": "subtype"
  "Issuer Subject Common Name": "issuer_cn"
  "Root Subject Common Name": "root_cn"
  "Server Name Indication": "sni"

  # GTP — unmapped long names
  "End User IP Address": "end_ip_adr"
  "Serving Country MCC": "mcc"
  "Tunnel Inspection Rule": "tunnel_insp_rule"

# field_table_overrides: used ONLY to fill empty Variable Names in field tables
# (fields whose PA docs Field Name has no parenthetical at all).
# Keys are the long field name (text before the first "("), values are the correct variable name.
# Cross-referenced from other log types whose field tables do include the parenthetical.
# Unlike global_name_overrides, these are NOT merged into name_map and do NOT affect
# format string transformation — they only fix the *_fields.csv Variable Name column.
field_table_overrides:
  # Audit_Log — PA docs omit variable names from the field table for these fields;
  # names confirmed from System_Log and Config_Log field tables which do include them
  "Serial Number": "serial"
  "Generate Time": "time_generated"
  "Event ID": "eventid"
  "Object": "object"
  "CLI Command": "cmd"
  "Severity": "severity"

# token_corrections: applied to each output token after format string transformation.
# Keys are incorrect variable names that the scraper produces, values are the correct names.
# Fixes PA docs typos in the Variable Name column of field tables.
token_corrections:
  "FUTURE_USER": "FUTURE_USE" # User-ID log: typo in PA docs field table
  "high_res": "high_res_timestamp" # IP-Tag, User-ID, Auth, URL, Threat, etc.: truncated in PA field table
  "event_id": "eventid" # IP-Tag: underscore wrong in PA field table
  "tunnelid/imsi": "tunnel_id/imsi" # Traffic: PA field table lists without underscore first
  "nsdsai_sst": "nssai_sst" # GTP: "nsdsai" → "nssai" typo in PA docs
  "nsdsai_sd": "nssai_sd" # GTP: same typo

# per_log_corrections: corrections applied per log type, AFTER strip_leading_future_use
# removes position 0. Two selector types are supported:
#   - match: locate token by value (position-independent; preferred when token value is known)
#   - position: locate token by 0-indexed position (fallback when value is not distinctive)
# Two correction types are supported:
#   - new: replace the selected token with a new value
#   - split_into: replace the selected token with a list of tokens (expands length by len-1)
per_log_corrections:
  GlobalProtect_Log:
    # The format string has "Serial Number" at two positions: position 2 (firewall serial,
    # should be "serial") and position 20 (machine serial, should be "serialnumber"). Both
    # auto-map to "serialnumber" via the field table ("Serial Number (serialnumber)").
    # match: finds the first occurrence (position 2) and replaces it; position 20 is untouched.
    - match: "serialnumber"
      new: "serial"

  Correlated_Events_Log:
    # PA docs bug: period instead of comma produces single token "Source Address. Source User".
    # match: used instead of position: so the fix is independent of strip_leading_future_use.
    - match: "Source Address. Source User"
      split_into: ["src", "srcuser"]
